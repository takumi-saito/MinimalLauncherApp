name: Claude Assistant
on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned, labeled]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, edited, synchronize, ready_for_review]

jobs:
  claude-response:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up JDK 17
        uses: actions/setup-java@387ac29b308b003ca37ba93a6cab5eb57c8f5f93 # v4.0.0
        with:
          distribution: temurin
          java-version: 17

      # Better than caching and/or extensions of actions/setup-java
      - name: Setup Gradle
        uses: gradle/gradle-build-action@87a9a15658c426a54dd469d4fc7dc1a73ca9d4a6 # v2.10.0
        with:
          gradle-version: wrapper

      - uses: anthropics/claude-code-action@beta
        with:
          # anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Or use OAuth token instead:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          allowed_tools: "Bash(./gradlew:*),Bash(gradlew:*),Read(**),Grep(**),Edit(**)"
          # Optional: set execution mode (default: tag)
          # mode: "tag"
          # Optional: add custom trigger phrase (default: @claude)
          # trigger_phrase: "/claude"
          # Optional: add assignee trigger for issues
          # assignee_trigger: "claude"
          # Optional: add label trigger for issues
          # label_trigger: "claude"
          # Optional: add custom environment variables (YAML format)
          # claude_env: |
          #   NODE_ENV: test
          #   DEBUG: true
          #   API_URL: https://api.example.com
          # Optional: limit the number of conversation turns
          # max_turns: "5"
          # Optional: grant additional permissions (requires corresponding GitHub token permissions)
          # additional_permissions: |
          #   actions: read
          # Custom instructions for Claude
          custom_instructions: |
            必ず日本語で回答してください。技術用語は英語のままで構いません。
            
            ## Pull Request レビュー時の動作
            
            Pull Request に対してコメントされた場合、または新規 PR が作成された場合：
            
            1. **PR テンプレート解析**
               - .github/pull_request_template.md を参照
               - PR の本文から以下の情報を抽出：
                 - 変更種別（新機能、バグ修正、リファクタリングなど）
                 - 変更詳細と主要ファイル
                 - テスト実施状況
                 - AI Agent メタデータ（YAML 形式）
            
            2. **自動チェック項目**
               - [ ] PR テンプレートの必須項目が記入されているか確認
               - [ ] テストコマンドが実行されているか確認
               - [ ] 破壊的変更の有無を確認
               - [ ] パフォーマンス影響を評価
               - [ ] Android 固有の考慮事項をチェック：
                 - 最小 SDK 26 との互換性
                 - ターゲット SDK 33 への準拠
                 - Material Design ガイドライン準拠
            
            3. **コードレビュー基準**
               - Kotlin/Java のコーディング規約遵守
               - Jetpack Compose ベストプラクティス
               - Hilt DI の適切な使用
               - リソースリークの防止
               - スレッドセーフティ
               - メモリ効率（ランチャーアプリとして重要）
            
            4. **レビューコメントフォーマット**
               ```markdown
               ## 🤖 Claude Code レビュー結果
               
               ### ✅ 良い点
               - 
               
               ### ⚠️ 改善提案
               - 
               
               ### 🐛 潜在的な問題
               - 
               
               ### 📊 メトリクス
               - コードカバレッジ: X%
               - Lint 警告: X 件
               - ビルド時間への影響: +Xs
               ```
            
            ## コード実装時の品質確保
            
            コード実装後は、以下のコマンドを順番に必ず実行してコード品質を確保してください：
            1. './gradlew lint' を実行して Android lint の問題をチェック
            2. 発見された lint の警告やエラーを報告
            3. lint の問題がある場合は修正を試みる
            4. './gradlew test' を実行してユニットテストを確認
            5. './gradlew assembleDebug' を実行してビルドが成功することを確認
            6. ビルドエラーが発生した場合は、エラー内容を報告して修正を試みる
            
            重要：コード実装タスクの最終ステップとして、必ず lint チェック、テスト、ビルド確認を実行してください。
            
            ## コミットメッセージ作成ルール
            
            git commit を作成する際は、必ずこのリポジトリの .commit_template ファイルを参照し、そこに記載されているフォーマットと絵文字のルールに完全に従ってください。
            
            具体的には：
            1. .commit_template ファイルを読み込んで内容を確認する
            2. 適切な絵文字を選択（:sparkles:, :+1:, :bug: など）
            3. フォーマット `:emoji: Subject` に従う
            4. Subject は50文字以内、命令形で記述
            5. Body がある場合は、Subject と1行空けて、72文字以内で What/Why を記載
            
            ## Android 開発固有のガイドライン
            
            1. **Compose 移行サポート**
               - Fragment から Compose への段階的移行を支援
               - Compose のベストプラクティスを適用
               - State hoisting とリコンポジション最適化
            
            2. **パフォーマンス最適化**
               - ランチャーアプリとしての起動速度を重視
               - メモリ使用量の最小化
               - バッテリー消費の考慮
            
            3. **テスト戦略**
               - JUnit でのユニットテスト
               - Compose UI テスト
               - Espresso での統合テスト
